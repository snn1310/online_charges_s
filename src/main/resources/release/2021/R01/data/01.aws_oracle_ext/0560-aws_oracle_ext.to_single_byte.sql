CREATE OR REPLACE FUNCTION aws_oracle_ext.to_single_byte(p_str TEXT)
RETURNS TEXT
AS
$$
DECLARE
  db_encoding TEXT;

  TO_MULTI_BYTE_UTF8 CONSTANT TEXT[95] :=
  ARRAY
  [
	'\343\200\200',
	'\357\274\201',
	'\342\200\235',
	'\357\274\203',
	'\357\274\204',
	'\357\274\205',
	'\357\274\206',
	'\342\200\231',
	'\357\274\210',
	'\357\274\211',
	'\357\274\212',
	'\357\274\213',
	'\357\274\214',
	'\357\274\215',
	'\357\274\216',
	'\357\274\217',
	'\357\274\220',
	'\357\274\221',
	'\357\274\222',
	'\357\274\223',
	'\357\274\224',
	'\357\274\225',
	'\357\274\226',
	'\357\274\227',
	'\357\274\230',
	'\357\274\231',
	'\357\274\232',
	'\357\274\233',
	'\357\274\234',
	'\357\274\235',
	'\357\274\236',
	'\357\274\237',
	'\357\274\240',
	'\357\274\241',
	'\357\274\242',
	'\357\274\243',
	'\357\274\244',
	'\357\274\245',
	'\357\274\246',
	'\357\274\247',
	'\357\274\250',
	'\357\274\251',
	'\357\274\252',
	'\357\274\253',
	'\357\274\254',
	'\357\274\255',
	'\357\274\256',
	'\357\274\257',
	'\357\274\260',
	'\357\274\261',
	'\357\274\262',
	'\357\274\263',
	'\357\274\264',
	'\357\274\265',
	'\357\274\266',
	'\357\274\267',
	'\357\274\270',
	'\357\274\271',
	'\357\274\272',
	'\357\274\273',
	'\357\277\245',
	'\357\274\275',
	'\357\274\276',
	'\357\274\277',
	'\342\200\230',
	'\357\275\201',
	'\357\275\202',
	'\357\275\203',
	'\357\275\204',
	'\357\275\205',
	'\357\275\206',
	'\357\275\207',
	'\357\275\210',
	'\357\275\211',
	'\357\275\212',
	'\357\275\213',
	'\357\275\214',
	'\357\275\215',
	'\357\275\216',
	'\357\275\217',
	'\357\275\220',
	'\357\275\221',
	'\357\275\222',
	'\357\275\223',
	'\357\275\224',
	'\357\275\225',
	'\357\275\226',
	'\357\275\227',
	'\357\275\230',
	'\357\275\231',
	'\357\275\232',
	'\357\275\233',
	'\357\275\234',
	'\357\275\235',
	'\357\275\236',
	'\357\277\243'
  ];

  TO_MULTI_BYTE_EUCJP CONSTANT TEXT[95] :=
  ARRAY
  [
	'\241\241',
	'\241\252',
	'\241\311',
	'\241\364',
	'\241\360',
	'\241\363',
	'\241\365',
	'\241\307',
	'\241\312',
	'\241\313',
	'\241\366',
	'\241\334',
	'\241\244',
	'\241\335',
	'\241\245',
	'\241\277',
	'\243\260',
	'\243\261',
	'\243\262',
	'\243\263',
	'\243\264',
	'\243\265',
	'\243\266',
	'\243\267',
	'\243\270',
	'\243\271',
	'\241\247',
	'\241\250',
	'\241\343',
	'\241\341',
	'\241\344',
	'\241\251',
	'\241\367',
	'\243\301',
	'\243\302',
	'\243\303',
	'\243\304',
	'\243\305',
	'\243\306',
	'\243\307',
	'\243\310',
	'\243\311',
	'\243\312',
	'\243\313',
	'\243\314',
	'\243\315',
	'\243\316',
	'\243\317',
	'\243\320',
	'\243\321',
	'\243\322',
	'\243\323',
	'\243\324',
	'\243\325',
	'\243\326',
	'\243\327',
	'\243\330',
	'\243\331',
	'\243\332',
	'\241\316',
	'\241\357',
	'\241\317',
	'\241\260',
	'\241\262',
	'\241\306',
	'\243\341',
	'\243\342',
	'\243\343',
	'\243\344',
	'\243\345',
	'\243\346',
	'\243\347',
	'\243\350',
	'\243\351',
	'\243\352',
	'\243\353',
	'\243\354',
	'\243\355',
	'\243\356',
	'\243\357',
	'\243\360',
	'\243\361',
	'\243\362',
	'\243\363',
	'\243\364',
	'\243\365',
	'\243\366',
	'\243\367',
	'\243\370',
	'\243\371',
	'\243\372',
	'\241\320',
	'\241\303',
	'\241\321',
	'\241\301',
	'\241\261'
  ];

  map TEXT[];
  result TEXT;
BEGIN
  IF p_str ='' THEN RETURN NULL::TEXT; END IF;

  SELECT character_set_name FROM information_schema.character_sets INTO db_encoding;

  CASE db_encoding
    WHEN 'UTF8' THEN map := TO_MULTI_BYTE_UTF8;
    WHEN 'EUC_JP' THEN map := TO_MULTI_BYTE_EUCJP;
    WHEN 'PG_EUC_JIS_2004' THEN map := TO_MULTI_BYTE_EUCJP;
    ELSE RETURN p_str; --no need to convert
  END CASE;

  SELECT ARRAY_TO_STRING(ARRAY_AGG(CONCAT(CASE
                                            WHEN array_position(map,u) IS NOT NULL
                                            THEN CONVERT_FROM(DECODE(to_hex(array_position(map,u)+32-1),'hex'),db_encoding)
                                            ELSE v
                                          END
                                         ,'')
                                  )
                        ,'')
    FROM (SELECT v, encode(v::bytea,'escape') AS u
            FROM REGEXP_SPLIT_TO_TABLE(p_str,'') AS v) t
    INTO result;

  RETURN result;
END;
$$
LANGUAGE plpgsql
IMMUTABLE;
